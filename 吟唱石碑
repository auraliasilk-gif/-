{% schema %}
{
  "name": "ğŸ—¿ Genesis Monument V6",
  "settings": [
    {
      "type": "header",
      "content": "ğŸ”´ æ ¸å¿ƒæ•°æ®"
    },
    {
      "type": "product",
      "id": "target_product",
      "label": "ç»‘å®šæ³•å™¨",
      "info": "é»˜è®¤è¯»å–å½“å‰äº§å“ã€‚"
    },
    {
      "type": "header",
      "content": "ğŸ—¿ é»‘çŸ³æ¿æè´¨ (Slate Material)"
    },
    {
      "type": "range",
      "id": "bg_opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "%",
      "label": "çŸ³æ¿åº•è‰²æµ“åº¦",
      "default": 85,
      "info": "æ§åˆ¶é»‘çŸ³æ¿çš„æ·±æµ…ã€‚æ•°å€¼è¶Šé«˜è¶Šé»‘ï¼Œè¶Šä¸é€æ˜ã€‚"
    },
    {
      "type": "range",
      "id": "blur_amount",
      "min": 0,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "ç£¨ç ‚æ¨¡ç³Šåº¦ (èƒŒæ™¯é€è§†)",
      "default": 5,
      "info": "æ§åˆ¶çŸ³æ¿åæ–¹èƒŒæ™¯çš„æ¨¡ç³Šç¨‹åº¦ã€‚"
    },
    {
      "type": "range",
      "id": "border_width",
      "min": 0,
      "max": 5,
      "step": 1,
      "unit": "px",
      "label": "è¾¹æ¡†å®½åº¦",
      "default": 1
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "è¾¹æ¡†é¢œè‰²",
      "default": "#5A4A32"
    },
    {
      "type": "header",
      "content": "â˜ï¸ æ‚¬æµ®é˜´å½± (Levitation Shadow)"
    },
    {
      "type": "range",
      "id": "shadow_opacity",
      "min": 0,
      "max": 100,
      "step": 10,
      "unit": "%",
      "label": "é˜´å½±å¼ºåº¦",
      "default": 60
    },
    {
      "type": "range",
      "id": "shadow_y_offset",
      "min": 0,
      "max": 60,
      "step": 5,
      "unit": "px",
      "label": "æ‚¬æµ®é«˜åº¦ (Yè½´åç§»)",
      "default": 30
    },
    {
      "type": "range",
      "id": "shadow_blur",
      "min": 20,
      "max": 150,
      "step": 10,
      "unit": "px",
      "label": "é˜´å½±æ¨¡ç³ŠåŠå¾„ (æŸ”ç„¦)",
      "default": 80,
      "info": "æ•°å€¼è¶Šå¤§ï¼Œé˜´å½±è¶ŠæŸ”å’Œæ‰©æ•£ã€‚"
    },
    {
      "type": "header",
      "content": "ğŸ“ å°ºå¯¸ä¸å¸ƒå±€"
    },
    {
      "type": "range",
      "id": "slab_width",
      "min": 300,
      "max": 1200,
      "step": 50,
      "unit": "px",
      "label": "æœ€å¤§å®½åº¦é™åˆ¶",
      "default": 600
    },
    {
      "type": "range",
      "id": "mobile_padding",
      "min": 10,
      "max": 60,
      "step": 5,
      "unit": "px",
      "label": "æ‰‹æœºç«¯å†…éƒ¨è¾¹è·",
      "default": 30
    },
    {
      "type": "range",
      "id": "section_height_mobile",
      "min": 30,
      "max": 100,
      "step": 5,
      "unit": "vh",
      "label": "æ‰‹æœºç«¯é«˜åº¦",
      "default": 70
    },
    {
      "type": "range",
      "id": "section_height_desktop",
      "min": 30,
      "max": 100,
      "step": 5,
      "unit": "vh",
      "label": "ç”µè„‘ç«¯é«˜åº¦",
      "default": 80
    },
    {
      "type": "checkbox",
      "id": "hide_on_desktop",
      "label": "âŒ åœ¨ç”µè„‘ç«¯éšè—",
      "default": false
    },
    {
      "type": "header",
      "content": "âœï¸ è¯—æ­Œæ’ç‰ˆ"
    },
    {
      "type": "checkbox",
      "id": "enable_vertical_text",
      "label": "ğŸ“œ æ‰‹æœºç«¯å¯ç”¨ç«–æ’ (å±…ä¸­)",
      "default": true,
      "info": "å¼€å¯åï¼Œæ‰‹æœºç«¯æ–‡å­—å°†ä»å³å‘å·¦ç«–å‘æ’åˆ—å¹¶å±…ä¸­ã€‚ç”µè„‘ç«¯å¼ºåˆ¶æ¨ªæ’ã€‚"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "æ–‡å­—é¢œè‰²",
      "default": "#BFAE92"
    },
    {
      "type": "range",
      "id": "font_size_mobile",
      "min": 12,
      "max": 36,
      "step": 1,
      "unit": "px",
      "label": "æ‰‹æœºå­—å· (æ§åˆ¶å¤§å°)",
      "default": 18
    },
    {
      "type": "range",
      "id": "speed",
      "min": 2,
      "max": 10,
      "step": 1,
      "unit": "s",
      "label": "åŸå”±é€Ÿåº¦",
      "default": 4
    }
  ],
  "presets": [
    {
      "name": "ğŸ—¿ Genesis Monument V6"
    }
  ]
}
{% endschema %}

{% assign target_item = section.settings.target_product | default: product %}
{% assign poem_raw = target_item.metafields.custom['creat-poem'] %}

{% if poem_raw != blank %}

<style>
  /* [ å¤–éƒ¨å®¹å™¨ ] */
  .monument-section {
    position: relative;
    width: 100%;
    background: transparent; 
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
    overflow: hidden;
    height: {{ section.settings.section_height_mobile }}vh;
  }

  /* [ é»‘çŸ³æ¿ (Dark Slate Slab) ] */
  .monument-slab {
    position: relative;
    width: 100%;
    max-width: {{ section.settings.slab_width }}px;
    height: 100%;
    max-height: 85vh;
    padding: {{ section.settings.mobile_padding }}px;
    
    display: flex;
    justify-content: center;
    align-items: center;

    /* --- V6.0 æ ¸å¿ƒï¼šé»‘çŸ³æ¿æè´¨ --- */
    /* 1. åº•è‰²ï¼šæ·±ç°è‰²åº•å­ï¼Œæµ“åº¦ç”±è®¾ç½®å†³å®š */
    background-color: rgba(20, 20, 22, {{ section.settings.bg_opacity | divided_by: 100.0 }});
    
    /* 2. çº¹ç†ï¼šå åŠ å²©çŸ³æš—çº¹ */
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.15'/%3E%3C/svg%3E");
    background-blend-mode: overlay;

    /* 3. ç£¨ç ‚é€è§† */
    backdrop-filter: blur({{ section.settings.blur_amount }}px);
    -webkit-backdrop-filter: blur({{ section.settings.blur_amount }}px);
    
    /* 4. è¾¹æ¡† */
    border: {{ section.settings.border_width }}px solid {{ section.settings.border_color }};
    border-radius: 4px;

    /* --- V6.0 æ ¸å¿ƒï¼šæŸ”ç„¦æ‚¬æµ®é˜´å½± --- */
    /* Yè½´åç§» + æ¨¡ç³ŠåŠå¾„ (shadow_blur) + å¼ºåº¦ */
    box-shadow: 0 {{ section.settings.shadow_y_offset }}px {{ section.settings.shadow_blur }}px rgba(0, 0, 0, {{ section.settings.shadow_opacity | divided_by: 100.0 }});

    /* === å‡ºåœºåŠ¨ç”»åˆå§‹çŠ¶æ€ === */
    opacity: 0;
    transform: scale(0.92) translateY(20px); /* åˆå§‹å¾®ç¼©ä¸”ä¸‹æ²‰ */
    filter: blur(15px);
    transition: opacity 1.8s ease-out, transform 1.8s cubic-bezier(0.2, 0.8, 0.2, 1), filter 1.8s ease-out;
  }

  /* [ å”¤é†’çŠ¶æ€ ] */
  .monument-slab.revealed {
    opacity: 1;
    transform: scale(1) translateY(0);
    filter: blur(0);
  }

  /* [ è¯—å¥å®¹å™¨ ] */
  .poem-container {
    position: relative;
    z-index: 2;
    text-align: center;
    width: 100%;
    height: 100%;
    /* ç¡®ä¿å®¹å™¨æœ¬èº«ä¹Ÿæ˜¯å±…ä¸­å¯¹é½çš„ */
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* [ è¯—å¥ ] */
  .poem-line {
    font-family: serif; 
    line-height: 1.6;
    letter-spacing: 0.2em;
    color: {{ section.settings.text_color }};
    opacity: 0;
    position: absolute;
    /* æ ¸å¿ƒå±…ä¸­å®šä½ */
    top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0.95);
    transition: opacity 1.5s ease-in-out, transform 2s ease-out;
    
    /* å¤§å°æ§åˆ¶ï¼šç”±æ‰‹æœºå­—å·å†³å®š */
    font-size: {{ section.settings.font_size_mobile }}px;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5); 

    /* --- V6.0 æ ¸å¿ƒï¼šç«–æ’å±…ä¸­ä¿®æ­£ --- */
    {% if section.settings.enable_vertical_text %}
      writing-mode: vertical-rl;
      text-orientation: mixed;
      white-space: nowrap; 
      /* ç¡®ä¿åœ¨ç«–æ’æ¨¡å¼ä¸‹ï¼Œæ–‡æœ¬å—è‡ªèº«ä¸å æ»¡å®½åº¦ï¼Œä»è€Œè¢«ç»å¯¹å®šä½å®Œç¾å±…ä¸­ */
      width: auto; 
      height: auto;
      max-height: 90%; 
      text-align: center; /* ç¡®ä¿è¡Œå†…æ–‡å­—å±…ä¸­ */
    {% else %}
      width: 100%; /* æ¨ªæ’æ¨¡å¼ä¸‹å æ»¡å®½åº¦ */
    {% endif %}
  }

  .poem-line.active {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
    text-shadow: 0 0 25px {{ section.settings.text_color | color_modify: 'alpha', 0.4 }};
  }

  /* [ ç”µè„‘ç«¯é€‚é… ] */
  @media (min-width: 768px) {
    .monument-section {
      height: {{ section.settings.section_height_desktop }}vh;
      {% if section.settings.hide_on_desktop %}display: none !important;{% endif %}
    }
    .monument-slab {
        padding: 40px; /* ç”µè„‘ç«¯å†…è¾¹è·åŠ å¤§ */
    }
    .poem-line {
      font-size: calc({{ section.settings.font_size_mobile }}px + 8px);
      /* ç”µè„‘ç«¯å¼ºåˆ¶æ¢å¤æ¨ªæ’ */
      writing-mode: horizontal-tb !important; 
      white-space: normal !important;
      width: 100% !important;
    }
  }
</style>

<div class="monument-section">
  <div class="monument-slab" id="slab-{{ section.id }}">
    <div class="poem-container" id="poem-container-{{ section.id }}"></div>
  </div>
</div>

<script>
  (function() {
    var rawPoem = `{{ poem_raw }}`;
    var lines = rawPoem.split('\n').filter(line => line.trim() !== '');
    var container = document.getElementById('poem-container-{{ section.id }}');
    var slab = document.getElementById('slab-{{ section.id }}');
    var speed = {{ section.settings.speed }} * 1000;
    var currentIndex = 0;

    // 1. åˆå§‹åŒ– IntersectionObserver (è§†å£ç›‘å¬)
    var observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹è§¦å‘ï¼Œè®©ç”¨æˆ·çœ‹æ¸…å®ƒæµ®ç°çš„è¿‡ç¨‹
          setTimeout(() => {
              entry.target.classList.add('revealed');
          }, 100);
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.15 }); // è¿›å…¥è§†å£ 15% å³è§¦å‘

    if (slab) observer.observe(slab);

    // 2. è¯—æ­Œæ’­æ”¾é€»è¾‘
    container.innerHTML = '';
    lines.forEach((line) => {
      var p = document.createElement('div');
      p.classList.add('poem-line');
      p.innerText = line;
      container.appendChild(p);
    });

    var lineElements = container.querySelectorAll('.poem-line');
    function playChant() {
      lineElements.forEach(el => el.classList.remove('active'));
      if (lineElements[currentIndex]) lineElements[currentIndex].classList.add('active');
      currentIndex++;
      if (currentIndex >= lineElements.length) currentIndex = 0;
    }

    if (lines.length > 0) {
      // é¦–æ¬¡æ’­æ”¾å»¶è¿Ÿï¼Œé…åˆçŸ³æ¿å‡ºåœº
      setTimeout(playChant, 800);
      setInterval(playChant, speed);
    }
  })();
</script>

{% endif %}
