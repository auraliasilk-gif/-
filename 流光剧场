{% comment %}
  AURALIA TAROT THEATER
  Version: 10.0 (Geometry Rubbing, Absolute Roman Arch)
  Author: The Code Alchemist
{% endcomment %}

{%- assign card_bg_color = '#050505' -%}
{%- assign text_color = '#D4AF37' -%}
{%- assign cycle_duration = section.settings.cycle_duration | default: 12 -%}

<style>
  /* å…¨å±€å˜é‡å®šä¹‰ */
  #shopify-section-{{ section.id }} {
    --tarot-duration: {{ cycle_duration }}s;
    --tarot-radius-bottom: {{ section.settings.corner_radius }}px; 
    --tarot-gap-desktop: {{ section.settings.gap_desktop }}px;
    --tarot-blur-strength: 8px;
    
    /* ç”µè„‘ç«¯å‡ ä½•ï¼šåŸºå‡†å®½åº¦ */
    --desktop-card-width: {{ section.settings.desktop_card_width }}px;
    /* ç”µè„‘ç«¯æ ¸å¿ƒå…¬å¼ï¼šåŠå¾„ = å®½åº¦çš„ä¸€åŠ (ç»å¯¹åŠåœ†) */
    --desktop-arch-radius: calc(var(--desktop-card-width) / 2);

    /* æ‰‹æœºç«¯æ··æ²ŒèŒƒå›´ */
    --mobile-width-min: {{ section.settings.mobile_width_min }}%;
    --mobile-width-max: {{ section.settings.mobile_width_max }}%;
    
    /* è´¨æ„Ÿæ§åˆ¶ */
    --film-noise-opacity: {{ section.settings.noise_intensity | divided_by: 100.0 }};
    --card-shadow-opacity: {{ section.settings.shadow_intensity | divided_by: 100.0 }};
    
    /* çµé­‚æ»¤é•œ */
    --filter-opacity: {{ section.settings.filter_opacity | divided_by: 100.0 }};
    --filter-tone: {{ section.settings.filter_tone }};
  }

  /* å®¹å™¨ï¼šé»‘è‰²è™šç©º */
  .tarot-section-container {
    background-color: {{ card_bg_color }};
    padding: 6rem 1rem;
    position: relative;
    overflow: hidden;
  }

  /* ç¯å¢ƒåº•å™ª */
  .tarot-bg-noise {
    position: absolute;
    inset: 0;
    opacity: 0.05;
    pointer-events: none;
    z-index: 1;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
  }

  /* çµé­‚æ»¤é•œ */
  .soul-filter-overlay {
    position: absolute;
    inset: 0;
    z-index: 2;
    pointer-events: none;
    opacity: var(--filter-opacity);
    background: radial-gradient(circle at 50% 30%, var(--filter-tone), transparent 80%);
    mix-blend-mode: screen; 
  }

  /* -----------------------
     å¸ƒå±€ç½‘æ ¼
     ----------------------- */
  .tarot-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: var(--tarot-gap-desktop);
    max-width: 1400px;
    margin: 0 auto;
    position: relative;
    z-index: 3; 
  }

  /* -----------------------
     å¡ç‰‡å½¢æ€ï¼šç»å¯¹å‡ ä½• (Absolute Geometry)
     ----------------------- */
  .tarot-card {
    position: relative;
    aspect-ratio: 2 / 3;
    overflow: hidden;
    cursor: pointer;
    transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1), border-color 0.8s ease, box-shadow 0.8s ease;
    border: 1px solid rgba(212, 175, 55, 0.3);
    box-shadow: 0 10px 30px rgba(0,0,0, var(--card-shadow-opacity));
  }

  /* >>> ç”µè„‘ç«¯ (Desktop) <<< */
  @media (min-width: 769px) {
    .tarot-card {
      flex: 0 0 var(--desktop-card-width); 
      /* å®Œç¾æ‹“å°ï¼šé¡¶éƒ¨åœ†è§’ä¸¥æ ¼ç­‰äºå®½åº¦çš„ä¸€åŠ */
      {% if section.settings.enable_arch %}
        border-radius: var(--desktop-arch-radius) var(--desktop-arch-radius) var(--tarot-radius-bottom) var(--tarot-radius-bottom);
      {% else %}
        border-radius: var(--tarot-radius-bottom);
      {% endif %}
    }
  }

  /* >>> æ‰‹æœºç«¯ (Mobile - The Rubbing) <<< */
  @media (max-width: 768px) {
    .tarot-section-container {
       padding: 4rem 1rem; /* å®¹å™¨å·¦å³æœ‰ 1rem çš„ç•™ç™½ */
    }
    .tarot-grid {
      display: flex;
      flex-direction: column; 
      align-items: flex-start;
      gap: 3.5rem; 
      width: 100%;
    }
    
    .tarot-card {
      flex: none; 
      
      /* æ ¸å¿ƒä¿®å¤ï¼šåˆ©ç”¨ CSS å˜é‡åŠ¨æ€è®¡ç®—åœ†è§’ã€‚
         åœ¨ä¸‹æ–¹çš„ nth-child é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬ä¸ä»…è®¾ç½®å®½åº¦ï¼Œ
         è¿˜è®¾ç½®äº†å¯¹åº”çš„ --mobile-arch-radius (åŸºäº vw è®¡ç®—)ã€‚
      */
      {% if section.settings.enable_arch %}
        border-radius: var(--mobile-arch-radius) var(--mobile-arch-radius) var(--tarot-radius-bottom) var(--tarot-radius-bottom);
      {% else %}
        border-radius: var(--tarot-radius-bottom);
      {% endif %}
    }

    /* æ··æ²Œç®—æ³•ä¸å‡ ä½•æ‹“å°çš„ç»“åˆï¼š
       æˆ‘ä»¬å‡è®¾å±å¹•å®½åº¦ = 100vwã€‚å®¹å™¨ padding çº¦ 2remã€‚
       å› æ­¤ radius â‰ˆ (width_percent * 1vw) / 2
       è¿™é‡Œåšå¾®è°ƒä»¥é€‚é…çœŸå®è§†è§‰ã€‚
    */

    /* 1. å‘å·¦é  (Min Width) */
    .tarot-grid .tarot-card:nth-child(4n+1) {
      width: var(--mobile-width-min);
      /* è®¡ç®—åŠå¾„ï¼š(Min% / 2) vw */
      --mobile-arch-radius: calc(var(--mobile-width-min) * 0.5vw - 0.5rem);
      margin-right: auto; margin-left: 0;
    }
    
    /* 2. å‘å³é  (Max Width) */
    .tarot-grid .tarot-card:nth-child(4n+2) {
      width: var(--mobile-width-max);
      /* è®¡ç®—åŠå¾„ï¼š(Max% / 2) vw */
      --mobile-arch-radius: calc(var(--mobile-width-max) * 0.5vw - 0.5rem);
      margin-left: auto; margin-right: 0;
    }
    
    /* 3. å±…ä¸­ (Average) */
    .tarot-grid .tarot-card:nth-child(4n+3) {
      --avg-width: calc((var(--mobile-width-min) + var(--mobile-width-max)) / 2);
      width: var(--avg-width);
      /* è®¡ç®—åŠå¾„ */
      --mobile-arch-radius: calc(((var(--mobile-width-min) + var(--mobile-width-max)) / 2) * 0.5vw - 0.5rem);
      margin-left: auto; margin-right: auto; 
    }
    
    /* 4. åå³ (Max - 5%) */
    .tarot-grid .tarot-card:nth-child(4n+4) {
      --sub-max-width: calc(var(--mobile-width-max) - 5%);
      width: var(--sub-max-width);
      /* è®¡ç®—åŠå¾„ */
      --mobile-arch-radius: calc((var(--mobile-width-max) - 5) * 0.5vw - 0.5rem);
      margin-left: auto; margin-right: 5%; 
    }
  }

  /* -----------------------
     å¤å…¸çª—æ£‚ (Classical Frame)
     ----------------------- */
  {% if section.settings.enable_classical_border %}
  .tarot-card.classical-mode {
    border: 1px solid rgba(212, 175, 55, 0.4); 
    /* å†…åµŒé˜´å½±å±‚çº§ */
    box-shadow: 
      inset 0 0 0 3px #050505, 
      inset 0 0 0 4px rgba(212, 175, 55, 0.7), 
      inset 0 0 40px rgba(0,0,0, 0.8),
      0 10px 30px rgba(0,0,0, var(--card-shadow-opacity));
  }
  .tarot-card.classical-mode:hover {
    border-color: rgba(212, 175, 55, 1);
    transform: translateY(-8px);
    z-index: 10;
    box-shadow: 
      inset 0 0 0 3px #050505, 
      inset 0 0 0 4px #D4AF37, 
      inset 0 0 50px rgba(0,0,0, 1),
      0 0 40px rgba(212, 175, 55, 0.3);
  }
  {% else %}
  .tarot-card:hover {
    border-color: rgba(212, 175, 55, 1);
    box-shadow: 0 0 40px rgba(212, 175, 55, 0.25); 
    transform: translateY(-8px);
    z-index: 10;
  }
  {% endif %}

  /* èƒ¶ç‰‡é¢—ç²’å±‚ */
  .tarot-card::after {
    content: "";
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 5;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    opacity: var(--film-noise-opacity);
    mix-blend-mode: overlay;
    border-radius: inherit; 
  }

  /* -----------------------
     ç”µè„‘ç«¯ï¼šæœ‰æœºé”™è½
     ----------------------- */
  {% if section.settings.enable_organic %}
    @media (min-width: 769px) {
      .tarot-grid .tarot-card:nth-child(even) { margin-top: 5rem; }
      .tarot-grid .tarot-card:nth-child(3n) { transform: scale(0.96); }
      .tarot-grid .tarot-card:nth-child(3n):hover { transform: scale(0.96) translateY(-8px); }
      .tarot-grid .tarot-card:nth-child(5n) { transform: scale(1.02); }
      .tarot-grid .tarot-card:nth-child(5n):hover { transform: scale(1.02) translateY(-8px); }
    }
  {% endif %}

  /* -----------------------
     å¹»è±¡å±‚ï¼šè¿·é›¾æµå˜
     ----------------------- */
  .tarot-visual-layer {
    position: absolute;
    inset: 0;
    z-index: 1;
    background: #111; 
  }
  .tarot-image {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0;
    filter: blur(var(--tarot-blur-strength)); 
    will-change: opacity, filter;
  }
  .tarot-image:nth-child(1) { animation: fluxOne var(--tarot-duration) infinite ease-in-out; }
  .tarot-image:nth-child(2) { animation: fluxTwo var(--tarot-duration) infinite ease-in-out; }
  .tarot-image:nth-child(3) { animation: fluxThree var(--tarot-duration) infinite ease-in-out; }

  @keyframes fluxOne {
    0% { opacity: 0; filter: blur(var(--tarot-blur-strength)); }
    10% { opacity: 1; filter: blur(0px); } 
    30% { opacity: 1; filter: blur(0px); } 
    40% { opacity: 0; filter: blur(var(--tarot-blur-strength)); } 
    100% { opacity: 0; filter: blur(var(--tarot-blur-strength)); }
  }
  @keyframes fluxTwo {
    0%, 33% { opacity: 0; filter: blur(var(--tarot-blur-strength)); }
    43% { opacity: 1; filter: blur(0px); }
    63% { opacity: 1; filter: blur(0px); }
    73% { opacity: 0; filter: blur(var(--tarot-blur-strength)); }
    100% { opacity: 0; filter: blur(var(--tarot-blur-strength)); }
  }
  @keyframes fluxThree {
    0%, 66% { opacity: 0; filter: blur(var(--tarot-blur-strength)); }
    76% { opacity: 1; filter: blur(0px); }
    96% { opacity: 1; filter: blur(0px); }
    100% { opacity: 0; filter: blur(var(--tarot-blur-strength)); }
  }

  /* -----------------------
     çµé­‚å±‚ (Soul Layer)
     ----------------------- */
  .tarot-soul-layer {
    position: absolute;
    inset: 0;
    z-index: 6; 
    background: linear-gradient(to top, rgba(5,5,5,0.95) 0%, rgba(5,5,5,0.3) 40%, rgba(5,5,5,0) 100%);
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 2rem;
    opacity: 0; 
    transition: opacity 0.8s ease;
    border-radius: inherit;
  }
  .tarot-card:hover .tarot-soul-layer { opacity: 1; }
  
  .tarot-chant {
    font-family: 'Times New Roman', serif;
    font-style: italic;
    font-size: 0.9rem;
    color: #aaa;
    margin-bottom: 0.5rem;
    letter-spacing: 0.05em;
    transform: translateY(10px);
    transition: transform 0.6s ease;
  }
  .tarot-card:hover .tarot-chant { transform: translateY(0); }

  .tarot-title {
    font-family: 'Times New Roman', serif;
    font-size: 1.4rem;
    color: {{ text_color }};
    margin-bottom: 1.5rem;
    letter-spacing: 0.1em;
    font-weight: normal;
    text-shadow: 0 0 10px rgba(0,0,0,0.5);
  }
  .tarot-decree-btn {
    display: inline-block;
    color: {{ text_color }};
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    padding-bottom: 5px;
    border-bottom: 1px solid {{ text_color }};
  }

  @media (max-width: 768px) {
    .tarot-soul-layer { opacity: 1; padding: 1.2rem; }
    .tarot-title { font-size: 1.1rem; }
    .tarot-chant { display: none; } 
  }
</style>

<div class="tarot-section-container">
  <div class="tarot-bg-noise"></div>
  <div class="soul-filter-overlay"></div> 
  
  <div class="tarot-grid">
    {%- assign target_products = section.settings.source_collection.products -%}
    {%- if target_products == empty -%}
       <div style="color:#D4AF37; width:100%; text-align:center; z-index:10;">
         [ç³»ç»Ÿ] è™šç©ºä¹‹ä¸­å¹¶æ— å›å“ã€‚è¯·åœ¨é…ç½®é¢æ¿é€‰æ‹©ä¸€ä¸ªäº§å“ç³»åˆ—ã€‚
       </div>
    {%- endif -%}

    {%- for product in target_products limit: section.settings.items_to_show -%}
      {%- assign img_list = product.metafields.custom.tarot_images.value -%}
      {%- assign chant = product.metafields.custom.tarot_chant | default: "The silence speaks" -%}
      {%- assign decree = product.metafields.custom.tarot_decree | default: "è¿æ¥ç»ˆå±€" -%}
      {%- assign delay_seed = forloop.index0 | times: 2.0 -%}
      
      {%- assign loading_strategy = 'lazy' -%}
      {%- assign fetch_priority = 'auto' -%}
      {%- if forloop.index <= 2 -%}
        {%- assign loading_strategy = 'eager' -%}
        {%- assign fetch_priority = 'high' -%}
      {%- endif -%}

      <div class="tarot-card {% if section.settings.enable_classical_border %}classical-mode{% endif %}" 
           onclick="window.location.href='{{ product.url }}'"
           style="--animation-delay: -{{ delay_seed }}s;">
        
        <div class="tarot-visual-layer">
          {%- if img_list != blank and img_list.count >= 3 -%}
            {%- for img in img_list limit: 3 -%}
              {%- if forloop.first -%}
                 {{ img | image_url: width: 800 | image_tag: 
                    loading: loading_strategy, 
                    fetchpriority: fetch_priority, 
                    class: 'tarot-image', 
                    style: 'animation-delay: var(--animation-delay);' 
                 }}
              {%- else -%}
                 {{ img | image_url: width: 800 | image_tag: 
                    loading: 'lazy', 
                    class: 'tarot-image', 
                    style: 'animation-delay: var(--animation-delay);' 
                 }}
              {%- endif -%}
            {%- endfor -%}
          {%- elsif product.featured_image != blank -%}
             {{ product.featured_image | image_url: width: 800 | image_tag: 
                loading: loading_strategy, 
                fetchpriority: fetch_priority,
                class: 'tarot-image',
                style: 'opacity: 1; filter: blur(0); animation: none;'
             }}
          {%- endif -%}
        </div>

        <div class="tarot-soul-layer">
          <div class="tarot-chant">{{ chant }}</div>
          <h3 class="tarot-title">{{ product.title }}</h3>
          <span class="tarot-decree-btn">> {{ decree }} <</span>
        </div>
        
      </div>
    {%- endfor -%}
  </div>
</div>

{% schema %}
{
  "name": "å¡”ç½—å‰§åœº (å‡ ä½•æ‹“å°ç‰ˆ)",
  "settings": [
    {
      "type": "header",
      "content": "ğŸ”® æ•°æ®æº"
    },
    {
      "type": "collection",
      "id": "source_collection",
      "label": "é€‰æ‹©äº§å“ç³»åˆ—"
    },
    {
      "type": "range",
      "id": "items_to_show",
      "min": 4,
      "max": 24,
      "step": 1,
      "default": 6,
      "label": "æ˜¾åŒ–æ•°é‡"
    },
    {
      "type": "header",
      "content": "ğŸï¸ è´¨æ„Ÿä¸èƒ¶ç‰‡ (Texture)"
    },
    {
      "type": "range",
      "id": "noise_intensity",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 30,
      "label": "èƒ¶ç‰‡å™ªç‚¹å¼ºåº¦"
    },
    {
      "type": "range",
      "id": "shadow_intensity",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 50,
      "label": "æš—å½±æ·±åº¦"
    },
    {
      "type": "header",
      "content": "ğŸ“ å‡ ä½•æ§åˆ¶ (æ‹“å°é€»è¾‘)"
    },
    {
      "type": "range",
      "id": "desktop_card_width",
      "min": 200,
      "max": 500,
      "step": 10,
      "default": 300,
      "label": "ğŸ’» ç”µè„‘ç«¯ï¼šå¡ç‰‡å›ºå®šå®½åº¦",
      "info": "ç”µè„‘ç«¯æ‹±é—¨é¡¶éƒ¨åŠå¾„ = å®½åº¦ / 2"
    },
    {
      "type": "range",
      "id": "mobile_width_min",
      "min": 50,
      "max": 90,
      "step": 5,
      "default": 60,
      "label": "ğŸ“± æ‰‹æœºç«¯ï¼šæœ€å°å®½åº¦ (%)"
    },
    {
      "type": "range",
      "id": "mobile_width_max",
      "min": 50,
      "max": 100,
      "step": 5,
      "default": 90,
      "label": "ğŸ“± æ‰‹æœºç«¯ï¼šæœ€å¤§å®½åº¦ (%)"
    },
    {
      "type": "header",
      "content": "ğŸ›ï¸ è¾¹æ¡†ä¸å½¢æ€"
    },
    {
      "type": "checkbox",
      "id": "enable_arch",
      "label": "å¼€å¯ã€æ‹±é—¨ã€‘å½¢æ€",
      "default": true
    },
    {
      "type": "range",
      "id": "corner_radius",
      "min": 0,
      "max": 50,
      "step": 1,
      "default": 10,
      "label": "åº•éƒ¨åœ†è§’åŠå¾„ (px)",
      "info": "ä»…æ§åˆ¶åº•éƒ¨ã€‚"
    },
    {
      "type": "checkbox",
      "id": "enable_classical_border",
      "label": "å¼€å¯ã€å¤å…¸åŒçº¿ã€‘çª—æ£‚",
      "default": true
    },
    {
      "type": "header",
      "content": "âœ¨ çµé­‚æ»¤é•œ"
    },
    {
      "type": "range",
      "id": "filter_opacity",
      "min": 0,
      "max": 80,
      "step": 5,
      "default": 30,
      "label": "æ»¤é•œæµ“åº¦ (%)"
    },
    {
      "type": "color",
      "id": "filter_tone",
      "label": "æ»¤é•œè‰²è°ƒ",
      "default": "#4b0082"
    },
    {
      "type": "header",
      "content": "â³ èŠ‚å¥ä¸å¸ƒå±€"
    },
    {
      "type": "range",
      "id": "cycle_duration",
      "min": 5,
      "max": 20,
      "step": 1,
      "default": 12,
      "label": "è½®æ’­å‘¨æœŸ (ç§’)"
    },
    {
      "type": "checkbox",
      "id": "enable_organic",
      "label": "å¼€å¯ã€æœ‰æœºé”™è½ã€‘å¸ƒå±€",
      "default": true
    },
    {
      "type": "range",
      "id": "gap_desktop",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 40,
      "label": "ç”µè„‘ç«¯å¡ç‰‡é—´è· (px)"
    }
  ],
  "presets": [
    {
      "name": "Auralia å¡”ç½—å‰§åœº (æ‹“å°ç‰ˆ)"
    }
  ]
}
{% endschema %}
